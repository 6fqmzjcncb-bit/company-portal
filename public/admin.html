<!DOCTYPE html>
<html lang="tr">
<!-- DEBUG: FORCE VISUAL CHANGE v2.7 -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Y√∂netim Paneli - ≈ûirket Portalƒ±</title>
    <link rel="stylesheet" href="/css/style.css?v=2.5">
    <link rel="stylesheet" href="/css/custom-dropdown.css">
    <script>
        // FAILSAFE: Global Error Handler
        window.onerror = function (msg, url, line) {
            showAlert(`Sistem Hatasƒ±:\n${msg}\nSatƒ±r: ${line}`);
            document.querySelectorAll('tbody').forEach(el => {
                el.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center; padding:20px;">
                    ‚ö†Ô∏è KRƒ∞Tƒ∞K HATA: ${msg}
                </td></tr>`;
            });
            return false;
        };

        // FAILSAFE: Loading Watchdog (10s)
        setTimeout(() => {
            if (document.body.innerHTML.includes('loader')) {
                console.warn('‚ö†Ô∏è Loading stuck detected by watchdog');
                document.querySelectorAll('.loader').forEach(loader => {
                    const parent = loader.parentElement;
                    if (parent) {
                        parent.innerHTML = '<div style="color:red">‚ö†Ô∏è Yanƒ±t alƒ±namadƒ± (Watchdog). L√ºtfen sayfayƒ± yenileyin.</div>';
                    }
                });
            }
        }, 10000);

        // Utility: Timeout wrapper for fetch
        const fetchWithTimeout = async (resource, options = {}) => {
            const { timeout = 8000 } = options;
            let url = resource;
            if (url.includes('?')) {
                url += `&_t=${Date.now()}`;
            } else {
                url += `?_t=${Date.now()}`;
            }

            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    cache: 'no-store',
                    headers: {
                        ...options.headers,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        };

        async function checkAuth() {
            console.log('üîí Checking Auth...');

            // 1. Try Cache
            const cachedUser = localStorage.getItem('user_cache');
            if (cachedUser) {
                try {
                    const user = JSON.parse(cachedUser);
                    document.getElementById('userName').textContent = user.full_name;
                    document.getElementById('userRole').textContent = 'üëë Y√∂netici';
                } catch (e) { console.error('Cache error', e); }
            }

            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) {
                    window.location.href = '/index.html';
                    return;
                }
                const user = await response.json();
                console.log('üë§ User:', user);

                // Update Cache
                localStorage.setItem('user_cache', JSON.stringify(user));

                currentUserId = user.id; // Store globally

                if (user.role !== 'admin') {
                    window.location.href = '/dashboard.html';
                    return;
                }

                document.getElementById('userName').textContent = user.full_name;
                document.getElementById('userRole').textContent = 'üëë Y√∂netici';
            } catch (error) {
                console.error('Auth check failed:', error);
                if (!cachedUser) window.location.href = '/index.html';
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/index.html';
        }

        // --- Role Management ---
        const PERMISSION_NAMES = {
            'all': 'Tam Yetki (Admin)',
            'view_jobs': 'ƒ∞≈ü Listeleri',
            'view_products': '√úr√ºnler',
            'view_sources': 'Kaynaklar',
            'view_attendance': '√áalƒ±≈üma Kaydƒ±',
            'manage_salary': 'Maa≈ü Y√∂netimi'
        };

        async function loadRoles() {
            const container = document.getElementById('rolesContainer');
            try {
                const response = await fetch('/api/roles');
                const roles = await response.json();

                // Client-side filter for strict view
                const allowedNames = ['Y√∂netici', 'Personel', 'Stok Sorumlusu'];
                const filteredRoles = roles.filter(r => allowedNames.includes(r.name));

                container.innerHTML = filteredRoles.map(role => {
                    // Filter permissions: Only show ones that have a Turkish name in PERMISSION_NAMES
                    const validPermissions = role.permissions.filter(p => PERMISSION_NAMES[p]);

                    return `
                        <tr>
                            <td><strong>${role.name}</strong></td>
                            <td><small>${validPermissions.map(p => `<span class="badge badge-info" style="margin-right:4px;">${PERMISSION_NAMES[p]}</span>`).join('')}</small></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick='openEditRoleModal(${JSON.stringify(role).replace(/'/g, "&#39;")})'>D√ºzenle</button>
                                ${!role.is_system ? `<button class="btn btn-sm btn-danger" onclick="deleteRole(${role.id})">Sil</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update User Modal Role Select
                const userRoleSelect = document.getElementById('newRole');
                userRoleSelect.innerHTML = roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

            } catch (error) {
                console.error('Role load error:', error);
                container.innerHTML = '<tr><td colspan="3" class="text-danger">Roller y√ºklenemedi</td></tr>';
            }
        }

        async function submitRoleForm(e) {
            e.preventDefault();
            const id = document.getElementById('editRoleId').value;
            const name = document.getElementById('roleName').value;
            const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);

            const url = id ? `/api/roles/${id}` : '/api/roles';
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, permissions })
                });

                if (response.ok) {
                    closeModal('roleModal');
                    loadRoles();
                    showAlert(id ? 'Rol g√ºncellendi' : 'Rol olu≈üturuldu');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + res.error);
                }
            } catch (err) {
                showAlert('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
            }
        }

        async function deleteRole(id) {
            if (!confirm('Bu rol√º silmek istediƒüinize emin misiniz?')) return;
            try {
                const response = await fetch(`/api/roles/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadRoles();
                    showAlert('Rol silindi');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + res.error);
                }
            } catch (err) {
                showAlert('Silme ba≈üarƒ±sƒ±z');
            }
        }

        window.openRoleModal = function () {
            document.getElementById('roleForm').reset();
            document.getElementById('editRoleId').value = '';
            document.getElementById('roleModalTitle').innerText = 'Yeni Rol Ekle';
            document.querySelectorAll('input[name="permissions"]').forEach(cb => cb.checked = false);
            document.getElementById('roleModal').style.display = 'flex';
        }

        window.openEditRoleModal = function (role) {
            document.getElementById('roleForm').reset();
            document.getElementById('editRoleId').value = role.id;
            document.getElementById('roleModalTitle').innerText = 'Rol√º D√ºzenle';
            document.getElementById('roleName').value = role.name;

            // Check permissions
            document.querySelectorAll('input[name="permissions"]').forEach(cb => {
                cb.checked = role.permissions.includes(cb.value);
            });

            document.getElementById('roleModal').style.display = 'flex';
        }


        // --- User Management ---
        async function loadUsers() {
            const container = document.getElementById('usersContainer');
            try {
                const response = await fetchWithTimeout('/api/admin/users');
                if (!response.ok) throw new Error('Kullanƒ±cƒ±lar alƒ±namadƒ±');

                const users = await response.json();

                container.innerHTML = users.map(user => {
                    const linkedEmp = user.employee ? `<span class="badge badge-success">üë§ ${user.employee.full_name}</span>` : '<span class="text-muted">-</span>';
                    // Display Role Name: prioritizing the relation, falling back to legacy enum
                    let roleName = '<span class="text-muted">Rol Yok</span>';

                    if (user.userRole) {
                        roleName = user.userRole.name;
                    } else if (user.role === 'admin') {
                        roleName = 'Y√∂netici';
                    } else if (user.role === 'staff') {
                        roleName = 'Personel';
                    }

                    return `
                        <tr>
                        <td><strong>${user.full_name}</strong></td>
                        <td>${user.username}</td>
                        <td><span class="badge badge-secondary">${roleName}</span></td>
                        <td>${linkedEmp}</td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" onchange="toggleAccess(${user.id}, this.checked)" ${user.is_active !== false ? 'checked' : ''} ${user.role === 'admin' ? 'disabled' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </td>
                        <td>${new Date(user.created_at).toLocaleDateString('tr-TR')}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning" onclick="openPasswordModal(${user.id}, '${user.username}')">üîë ≈ûifre</button>
                            <button class="btn btn-sm btn-info" onclick="openEditUserRoleModal(${user.id}, '${user.username}', ${user.role_id || 'null'})">‚úèÔ∏è Rol</button>
                            ${user.id !== currentUserId ? `<button class="btn btn-sm btn-danger" onclick="confirmDeleteUser(${user.id})">Sil</button>` : ''}
                        </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Kullanƒ±cƒ± y√ºkleme hatasƒ±:', error);
                container.innerHTML = `<tr><td colspan="7" class="text-center text-danger">‚ö†Ô∏è Hata: ${error.message}</td></tr>`;
            }
        }

        let pendingDeleteId = null;

        function confirmDeleteUser(id) {
            pendingDeleteId = id;
            document.getElementById('confirmMessage').textContent = 'Bu kullanƒ±cƒ±yƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz!';
            document.getElementById('confirmDataBtn').onclick = executeDeleteUser;

            const modal = document.getElementById('confirmModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        async function executeDeleteUser() {
            if (!pendingDeleteId) return;
            closeModal('confirmModal');

            try {
                const response = await fetch(`/api/admin/users/${pendingDeleteId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadUsers();
                    showAlert('Kullanƒ±cƒ± silindi', 'success');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + res.error, 'error');
                }
            } catch (err) {
                showAlert('Silme i≈ülemi ba≈üarƒ±sƒ±z', 'error');
            }
            pendingDeleteId = null;
        }

        function addUser() {
            document.getElementById('userForm').reset();
            // Roles are already loaded into #newRole by loadRoles()
            const modal = document.getElementById('userModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        async function submitUserForm(e) {
            e.preventDefault();

            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const full_name = document.getElementById('newFullName').value;
            const role_id = document.getElementById('newRole').value; // Changed to role_id

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, full_name, role_id })
                });

                if (response.ok) {
                    closeModal('userModal');
                    loadUsers();
                    showAlert('Kullanƒ±cƒ± ba≈üarƒ±yla olu≈üturuldu');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + (res.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error(error);
                showAlert('Baƒülantƒ± hatasƒ±!');
            }
        }

        // ... (keep loadPaymentAccounts and others) ...

        // --- Initialization ---
        let currentUserId = null; // Store for valid delete check
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Admin Page v3.0 Loaded');

            await checkAuth();
            // Get ID from auth check ideally, but for now we rely on server preventing self-delete

            loadPaymentAccounts();
            loadRoles().then(() => loadUsers()); // Load roles first so User Modal is populated

            // Role Form
            const roleForm = document.getElementById('roleForm');
            if (roleForm) roleForm.addEventListener('submit', submitRoleForm);
        }); // Close DOMContentLoaded properly


        async function loadPaymentAccounts() {
            const container = document.getElementById('accountsContainer');
            if (container.innerHTML.includes('loader')) {
                container.innerHTML = '<tr><td colspan="4" class="text-center"><div class="loader"></div><br><small>Hesaplar aranƒ±yor...</small></td></tr>';
            }

            try {
                const response = await fetchWithTimeout('/api/payment-accounts');
                if (!response.ok) throw new Error(`Sunucu Hatasƒ±: ${response.status}`);
                const accounts = await response.json();

                if (accounts.length === 0) {
                    container.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Hesap bulunamadƒ± (Yeni ekleyin)</td></tr>';
                    return;
                }

                container.innerHTML = accounts.map(acc => `
                    <tr>
                        <td><strong>${acc.name}</strong></td>
                        <td>${acc.type === 'bank' ? 'Banka' : acc.type === 'credit_card' ? 'Kredi Kartƒ±' : 'Nakit'}</td>
                        <td>${acc.icon || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteAccount(${acc.id})">Sil</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Hesap y√ºkleme hatasƒ±:', error);
                const msg = error.name === 'AbortError' ? 'Zaman a≈üƒ±mƒ± (Sunucu yanƒ±t vermedi)' : error.message;
                container.innerHTML =
                    `<tr><td colspan="4" class="text-center text-danger">‚ö†Ô∏è Hata: ${msg} <br> <button class="btn btn-sm btn-outline-secondary mt-2" onclick="loadPaymentAccounts()">Tekrar Dene</button></td></tr>`;
            }
        }

        // --- Link Employee Functions ---
        let allEmployees = [];

        async function loadEmployeesForSelect() {
            try {
                const response = await fetch('/api/employees');
                if (!response.ok) return;
                allEmployees = await response.json();

                // Populate Select
                const select = document.getElementById('linkEmployeeSelect');
                select.innerHTML = '<option value="">-- Baƒülantƒ±yƒ± Kaldƒ±r --</option>' +
                    allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name} (${emp.role === 'manager' ? 'Y√∂netici' : 'Personel'})</option>`).join('');

            } catch (error) {
                console.error('Personel y√ºkleme hatasƒ±:', error);
            }
        }

        async function openLinkModal(userId, username, currentEmpId) {
            document.getElementById('linkUserId').value = userId;
            document.getElementById('linkUserName').value = username;

            await loadEmployeesForSelect();

            const select = document.getElementById('linkEmployeeSelect');
            if (currentEmpId) {
                select.value = currentEmpId;
            } else {
                select.value = "";
            }

            document.getElementById('linkEmployeeModal').style.display = 'flex';
        }

        async function saveLink() {
            const userId = document.getElementById('linkUserId').value;
            const empId = document.getElementById('linkEmployeeSelect').value;

            try {
                const response = await fetch(`/api/admin/users/${userId}/link-employee`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_id: empId || null })
                });

                const result = await response.json();

                if (response.ok) {
                    closeModal('linkEmployeeModal');
                    loadUsers();
                    showAlert('Baƒülantƒ± g√ºncellendi');
                } else {
                    showAlert('Hata: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                showAlert('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
            }
        }

        // Toggle User Access
        async function toggleAccess(userId, isActive) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/toggle-access`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });

                const result = await response.json();

                if (!response.ok) {
                    showAlert('Hata: ' + result.error, 'error');
                    // Revert checkbox if failed
                    loadUsers();
                }
            } catch (error) {
                console.error(error);
                showAlert('Baƒülantƒ± hatasƒ±', 'error');
                loadUsers();
            }
        }

        async function resetPassword() {
            const userId = document.getElementById('resetUserId').value;
            const newPass = document.getElementById('resetPassword').value;

            if (newPass.length < 6) {
                showAlert('≈ûifre en az 6 karakter olmalƒ±');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: newPass })
                });

                if (response.ok) {
                    closeModal('passwordModal');
                    showAlert('≈ûifre g√ºncellendi');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + (res.error || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z'));
                }
            } catch (error) {
                console.error(error);
                showAlert('Baƒülantƒ± hatasƒ±');
            }
        }

        function openPasswordModal(id, username) {
            document.getElementById('resetUserId').value = id;
            document.getElementById('resetUserName').value = username;
            document.getElementById('resetPassword').value = '';
            document.getElementById('passwordModal').style.display = 'flex';
        }

        async function debugSyncUsers() {
            if (!confirm('Eksik kullanƒ±cƒ±larƒ± otomatik olu≈üturmak istiyor musunuz?')) return;
            try {
                const response = await fetch('/api/admin/debug/sync-users-fix');
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadUsers();
                } else {
                    alert('Hata: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                alert('Baƒülantƒ± hatasƒ±');
            }
        }

        // Modal Utilities
        function openAccountModal() {
            document.getElementById('accountForm').reset();
            document.getElementById('accountModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }



        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Admin Page v2.7 Loaded');

            checkAuth();
            loadPaymentAccounts();
            loadUsers();

            // Account Form
            const accountForm = document.getElementById('accountForm');
            if (accountForm) {
                accountForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('accName').value;
                    const type = document.getElementById('accType').value;

                    // Auto-assign icon
                    let icon = 'üí∞';
                    if (type === 'bank') icon = 'üè¶';
                    else if (type === 'credit_card') icon = 'üí≥';
                    else if (type === 'cash') icon = 'üíµ';

                    try {
                        const response = await fetch('/api/payment-accounts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, type, icon })
                        });

                        if (response.ok) {
                            closeModal('accountModal');
                            loadPaymentAccounts();
                            showAlert('Hesap eklendi');
                        } else {
                            showAlert('Hata olu≈ütu!');
                        }
                    } catch (error) {
                        console.error('Form submit error:', error);
                        showAlert('Bir hata olu≈ütu: ' + error.message);
                    }
                });
            }

            // User Form
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', submitUserForm);
            }

            // Link Employee Form
            const linkForm = document.getElementById('linkEmployeeForm');
            if (linkForm) {
                linkForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveLink();
                });
            }

            // Unit Form
            const unitForm = document.getElementById('unitForm');
            if (unitForm) {
                unitForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('unitName').value;

                    try {
                        const response = await fetch('/api/units', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            closeModal('unitModal');
                            loadUnits();
                            showAlert('Birim eklendi');
                        } else {
                            showAlert('Hata: ' + (result.error || 'Bilinmeyen hata'));
                        }
                    } catch (error) {
                        console.error('Unit submit error:', error);
                        showAlert('Baƒülantƒ± hatasƒ±!');
                    }
                });
            }

            // Load Units Initial
            loadUnits();
        });
        // User Role Edit
        function openEditUserRoleModal(userId, username, currentRoleId) {
            document.getElementById('editUserRoleId').value = userId;
            document.getElementById('editUserRoleName').innerText = username;

            // Populate select with existing roles (reusing loadRoles logic if possible or just assuming #newRole is populated)
            // We need to clone options from #newRole or #roleName? No, from #newRole is best.
            const sourceSelect = document.getElementById('newRole');
            const targetSelect = document.getElementById('updateRoleSelect');
            targetSelect.innerHTML = sourceSelect.innerHTML;

            targetSelect.value = currentRoleId || '';
            document.getElementById('userRoleModal').style.display = 'flex';
        }

        async function submitUserRoleForm(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserRoleId').value;
            const roleId = document.getElementById('updateRoleSelect').value;

            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_id: roleId })
                });

                if (response.ok) {
                    closeModal('userRoleModal');
                    loadUsers();
                    showAlert('Kullanƒ±cƒ± rol√º g√ºncellendi');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + res.error);
                }
            } catch (error) {
                console.error(error);
                showAlert('Baƒülantƒ± hatasƒ±');
            }
        }

        // --- Unit Management ---
        async function loadUnits() {
            const container = document.getElementById('unitsContainer');
            if (!container) return;

            try {
                const response = await fetch('/api/units');
                if (!response.ok) throw new Error('Sunucu Hatasƒ±');
                const units = await response.json();

                if (units.length === 0) {
                    container.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Birim bulunamadƒ± (√ñrn: Adet)</td></tr>';
                    return;
                }

                container.innerHTML = units.map(u => `
                    <tr>
                        <td><strong>${u.name}</strong></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteUnit(${u.id})">Sil</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                container.innerHTML = '<tr><td colspan="2" class="text-danger text-center">Y√ºklenemedi</td></tr>';
            }
        }

        function openUnitModal() {
            const form = document.getElementById('unitForm');
            if (form) form.reset();
            document.getElementById('unitModal').style.display = 'flex';
        }

        async function deleteUnit(id) {
            if (!confirm('Bu √∂l√ß√º birimini sistemden kaldƒ±rmak istediƒüinize emin misiniz?')) return;
            try {
                const response = await fetch(`/api/units/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadUnits();
                    showAlert('Birim silindi');
                } else {
                    const res = await response.json();
                    showAlert('Hata: ' + res.error);
                }
            } catch (error) {
                showAlert('Baƒülantƒ± hatasƒ±');
            }
        }

        // --- Data Management ---
        function downloadBackup() {
            const date = new Date().toISOString().slice(0, 10);
            window.location.href = '/api/admin/data/export';
        }

        async function confirmRestore() {
            const fileInput = document.getElementById('restoreFile');
            if (!fileInput.files.length) {
                showAlert('L√ºtfen bir yedek dosyasƒ± (.json) se√ßin', 'error');
                return;
            }

            const file = fileInput.files[0];

            if (!confirm(`‚ö†Ô∏è Dƒ∞KKAT!\n\n"${file.name}" dosyasƒ±nƒ± y√ºklemek √ºzeresiniz.\n\nBU ƒ∞≈ûLEM MEVCUT T√úM VERƒ∞LERƒ∞ KALICI OLARAK Sƒ∞LECEK VE YEDEƒûƒ∞ Y√úKLEYECEKTƒ∞R.\n\nDevam etmek istiyor musunuz?`)) {
                return;
            }

            // Double Confirm
            if (!confirm('SON UYARI: Bu i≈ülem geri alƒ±namaz. Eƒüer emin deƒüilseniz ƒ∞ptal deyin.\n\nOnaylƒ±yor musunuz?')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const jsonContent = e.target.result;
                    // Basic Validation
                    try {
                        const parsed = JSON.parse(jsonContent);
                        if (!parsed.data) throw new Error('Dosya formatƒ± ge√ßersiz (data alanƒ± yok)');
                    } catch (parseErr) {
                        throw new Error('Dosya ge√ßerli bir JSON deƒüil veya bozuk.');
                    }

                    // Show loader overlay
                    const loader = document.createElement('div');
                    loader.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;color:white;flex-direction:column;font-family:sans-serif;"><h1>üîÑ Geri Y√ºkleniyor...</h1><p style="margin-top:10px; font-size:1.1rem;">L√ºtfen bekleyin, sayfayƒ± kapatmayƒ±n.</p></div>';
                    document.body.appendChild(loader);

                    const response = await fetch('/api/admin/data/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: jsonContent
                    });

                    if (response.ok) {
                        const res = await response.json();
                        alert(`‚úÖ ${res.message}`);
                        window.location.reload();
                    } else {
                        const res = await response.json();
                        throw new Error(res.error || 'Bilinmeyen hata');
                    }

                } catch (error) {
                    alert('‚ùå Hata: ' + error.message);
                    window.location.reload(); // Remove loader
                }
            };
            reader.readAsText(file);
        }

    </script>
</head>

<body>
    <!-- ... existing body ... -->
    <!-- INSERT MODAL AT BOTTOM -->
    <div id="userRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rol Deƒüi≈ütir: <span id="editUserRoleName"></span></h2>
                <button class="modal-close" onclick="closeModal('userRoleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="submitUserRoleForm(event)">
                    <input type="hidden" id="editUserRoleId">
                    <div class="form-group">
                        <label>Yeni Rol Se√ßin</label>
                        <select id="updateRoleSelect" class="form-control" required data-custom-dropdown
                            data-searchable="false" data-placeholder="Rol Se√ßiniz">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary"
                            onclick="closeModal('userRoleModal')">ƒ∞ptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <body>
        <div class="app-container">
            <aside class="sidebar">
                <div class="logo">
                    <span class="logo-icon">üè¢</span>
                    ≈ûirket Portalƒ±
                </div>

                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/dashboard.html" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            Ana Sayfa
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/jobs.html" class="nav-link">
                            <span class="nav-icon">üìã</span>
                            ƒ∞≈ü Listeleri
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/sources.html" class="nav-link">
                            <span class="nav-icon">üì¶</span>
                            Kaynaklar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/products.html" class="nav-link">
                            <span class="nav-icon">üîß</span>
                            √úr√ºnler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/attendance.html" class="nav-link">
                            <span class="nav-icon">üìÖ</span>
                            √áalƒ±≈üma Kaydƒ±
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/salary.html" class="nav-link">
                            <span class="nav-icon">üí∞</span>
                            Maa≈ü Y√∂netimi
                        </a>
                    </li>

                    <li class="nav-item" id="adminLink">
                        <a href="/admin.html" class="nav-link active">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            Y√∂netim
                        </a>
                    </li>
                </ul>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">üë§</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Sistem Y√∂neticisi</div>
                            <div class="user-role" id="userRole">üëë Y√∂netici</div>
                        </div>
                    </div>
                    <button class="btn-logout" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
                </div>
            </aside>
            <main class="main-content">
                <button id="sidebarToggle" class="btn-icon mobile-only">‚ò∞</button>
                <h1 class="page-title mb-4">Y√∂netim Paneli</h1>



                <div class="card mb-4">
                    <div class="card-header">
                        <span>üí≥ √ñdeme Hesaplarƒ± (Kasa/Banka)</span>
                        <button class="btn btn-success btn-sm" onclick="openAccountModal()">+ Yeni Hesap</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Hesap Adƒ±</th>
                                    <th>Tip</th>
                                    <th>ƒ∞kon</th>
                                    <th>ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="accountsContainer">
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Roles Management Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <span>üõ°Ô∏è Rol Y√∂netimi ve Yetkiler</span>
                        <button class="btn btn-secondary btn-sm" onclick="openRoleModal()">+ Yeni Rol</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rol Adƒ±</th>
                                    <th>Yetkiler</th>
                                    <th>ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="rolesContainer">
                                <tr>
                                    <td colspan="3" class="text-center">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span>üë• Kullanƒ±cƒ±lar</span>
                        <button class="btn btn-primary btn-sm" onclick="addUser()">+ Yeni Kullanƒ±cƒ±</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Kullanƒ±cƒ± Adƒ±</th>
                                    <th>Rol</th>
                                    <th>Baƒülƒ± Personel</th>
                                    <th>Eri≈üim</th>
                                    <th>Kayƒ±t Tarihi</th>
                                    <th>ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="usersContainer">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Units Management Card -->
                <div class="card mt-4">
                    <div class="card-header" style="background-color: #f8fafc; padding: 1rem;">
                        <span style="color: #334155; font-weight: bold;">üìè Birim Y√∂netimi (√ñl√ß√º Birimleri)</span>
                        <button class="btn btn-primary btn-sm" onclick="openUnitModal()">+ Yeni Birim Ekle</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th>Birim Adƒ±</th>
                                    <th style="width: 150px;">ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="unitsContainer">
                                <tr>
                                    <td colspan="2" class="text-center text-muted">Birimler y√ºkleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Data Management Card -->
                <div class="card mt-4" style="border-top: 4px solid #3b82f6;">
                    <div class="card-header" style="background-color: #eff6ff; padding: 1rem;">
                        <span style="color: #1e40af; font-weight: bold;">üíæ Veri Y√∂netimi (Yedekle & Geri Y√ºkle)</span>
                    </div>
                    <div class="card-body p-4">
                        <div style="display: flex; gap: 20px; align-items: stretch; flex-wrap: wrap;">
                            <!-- Export Section -->
                            <div
                                style="flex: 1; min-width: 300px; border: 1px dashed #cbd5e1; padding: 20px; border-radius: 8px; background: #f8fafc;">
                                <h4 style="margin-top:0;">üì§ Yedek Al (Export)</h4>
                                <p class="text-muted small">T√ºm veritabanƒ±nƒ± (Kullanƒ±cƒ±lar, √úr√ºnler, Stoklar, vb.) JSON
                                    formatƒ±nda indirir. Bu dosyayƒ± saklayarak daha sonra sistemi geri y√ºkleyebilirsiniz.
                                </p>
                                <button class="btn btn-primary btn-block" onclick="downloadBackup()">
                                    ‚¨áÔ∏è Verileri ƒ∞ndir (.json)
                                </button>
                            </div>

                            <!-- Import Section -->
                            <div
                                style="flex: 1; min-width: 300px; border: 1px dashed #ef4444; padding: 20px; border-radius: 8px; background: #fef2f2;">
                                <h4 style="color: #b91c1c; margin-top:0;">üì• Geri Y√ºkle (Import)</h4>
                                <p class="text-danger small" style="font-weight: bold;">‚ö†Ô∏è Dƒ∞KKAT: Bu i≈ülem mevcut t√ºm
                                    verileri Sƒ∞LER ve se√ßilen yedek dosyasƒ±ndaki verileri y√ºkler!</p>

                                <div class="backup-actions">
                                    <input type="file" id="restoreFile" accept=".json" class="form-control"
                                        style="padding: 5px;">
                                    <button class="btn btn-danger" onclick="confirmRestore()">
                                        ‚ö†Ô∏è Y√ºkle
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Account Add Modal -->
            <div id="accountModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Yeni √ñdeme Hesabƒ± Ekle</h2>
                        <button class="modal-close" onclick="closeModal('accountModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="accountForm">
                            <div class="form-group">
                                <label>Hesap Adƒ±</label>
                                <input type="text" id="accName" placeholder="√ñrn: Ziraat Bankasƒ±" required>
                            </div>

                            <div class="form-group">
                                <label>Hesap Tipi</label>
                                <select id="accType" class="form-control" data-custom-dropdown data-searchable="false"
                                    data-placeholder="T√ºr Se√ßiniz">
                                    <option value="bank">Banka</option>
                                    <option value="cash">Nakit Kasa</option>
                                    <option value="credit_card">Kredi Kartƒ±</option>
                                </select>
                            </div>



                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeModal('accountModal')">ƒ∞ptal</button>
                                <button type="submit" class="btn btn-primary">Hesabƒ± Olu≈ütur</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Unit Add Modal -->
            <div id="unitModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Yeni Birim Ekle</h2>
                        <button class="modal-close" onclick="closeModal('unitModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="unitForm">
                            <div class="form-group">
                                <label>Birim Adƒ±</label>
                                <input type="text" id="unitName" placeholder="√ñrn: Adet, Metre, Litre" required
                                    autocomplete="off">
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeModal('unitModal')">ƒ∞ptal</button>
                                <button type="submit" class="btn btn-primary">Kaydet</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Add User Modal -->
            <div id="userModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Yeni Kullanƒ±cƒ± Ekle</h2>
                        <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <div class="form-group">
                                <label>Kullanƒ±cƒ± Adƒ±</label>
                                <input type="text" id="newUsername" required placeholder="Giri≈ü i√ßin kullanƒ±lacak">
                            </div>

                            <div class="form-group">
                                <label>≈ûifre</label>
                                <input type="password" id="newPassword" required placeholder="En az 6 karakter">
                            </div>

                            <div class="form-group">
                                <label>Ad Soyad</label>
                                <input type="text" id="newFullName" required placeholder="G√∂r√ºnecek isim">
                            </div>

                            <div class="form-group">
                                <label>Rol</label>
                                <select id="newRole" data-custom-dropdown data-searchable="false"
                                    data-placeholder="Rol Se√ßiniz">
                                    <option value="staff">Personel</option>
                                    <option value="admin">Y√∂netici</option>
                                </select>
                            </div>

                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeModal('userModal')">ƒ∞ptal</button>
                                <button type="submit" class="btn btn-primary">Kullanƒ±cƒ±yƒ± Olu≈ütur</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Role Add Modal -->
            <div id="roleModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="roleModalTitle">Yeni Rol Ekle</h2>
                        <button class="modal-close" onclick="closeModal('roleModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="roleForm">
                            <input type="hidden" id="editRoleId">
                            <div class="form-group">
                                <label>Rol Adƒ±</label>
                                <input type="text" id="roleName" required placeholder="√ñrn: Muhasebe">
                            </div>

                            <div class="form-group">
                                <label>Yetkiler</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <label><input type="checkbox" name="permissions" value="all"> <strong>Tam Yetki
                                            (Admin)</strong></label>

                                    <label><input type="checkbox" name="permissions" value="view_jobs"> ƒ∞≈ü
                                        Listeleri</label>
                                    <label><input type="checkbox" name="permissions" value="view_sources">
                                        Kaynaklar</label>
                                    <label><input type="checkbox" name="permissions" value="view_products">
                                        √úr√ºnler</label>
                                    <label><input type="checkbox" name="permissions" value="view_attendance"> √áalƒ±≈üma
                                        Kaydƒ±</label>

                                    <label><input type="checkbox" name="permissions" value="manage_salary"> Maa≈ü
                                        Y√∂netimi</label>
                                </div>
                            </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('roleModal')">ƒ∞ptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirmModal" class="modal">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 10px;">‚ùì</div>
                <h2 class="modal-title" style="justify-content: center; margin-bottom: 10px;">Emin misiniz?</h2>
                <p id="confirmMessage"
                    style="font-size: 1.1rem; color: #4b5563; margin-bottom: 25px; line-height: 1.5;"></p>
                <div class="modal-actions" style="justify-content: center;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('confirmModal')">Vazge√ß</button>
                    <button type="button" class="btn btn-danger" id="confirmDataBtn">Evet, Sil</button>
                </div>
            </div>
        </div>

        <!-- Link Employee Modal -->
        <div id="linkEmployeeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Kullanƒ±cƒ± - Personel E≈üle≈ümesi</h2>
                    <button class="modal-close" onclick="closeModal('linkEmployeeModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="mb-3 text-muted">Bu kullanƒ±cƒ±yƒ± bir personel ile e≈üle≈ütirin. B√∂ylece personel sadece kendi
                        verilerini g√∂r√ºr.</p>
                    <form id="linkEmployeeForm">
                        <input type="hidden" id="linkUserId">
                        <div class="form-group">
                            <label>Kullanƒ±cƒ±</label>
                            <input type="text" id="linkUserName" class="form-control" disabled
                                style="background: #f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label>Baƒülanacak Personel</label>
                            <select id="linkEmployeeSelect" class="form-control" data-custom-dropdown
                                data-searchable="true" data-placeholder="Personel Se√ßiniz">
                                <option value="">Se√ßiniz...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <small class="text-warning" id="linkWarning" style="display: none;">‚ö†Ô∏è Bu personel zaten
                                ba≈üka bir kullanƒ±cƒ±ya baƒülƒ±. Deƒüi≈ütirirseniz eski baƒülantƒ± kopar.</small>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary"
                                onclick="closeModal('linkEmployeeModal')">Vazge√ß</button>
                            <button type="submit" class="btn btn-primary">Kaydet ve E≈üle≈ütir</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Password Reset Modal -->
        <div id="passwordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>≈ûifre Deƒüi≈ütir</h2>
                    <button class="modal-close" onclick="closeModal('passwordModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form onsubmit="event.preventDefault(); resetPassword();">
                        <input type="hidden" id="resetUserId">
                        <div class="form-group">
                            <label>Kullanƒ±cƒ±</label>
                            <input type="text" id="resetUserName" class="form-control" disabled
                                style="background: #f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label>Yeni ≈ûifre</label>
                            <input type="text" id="resetPassword" class="form-control" required
                                placeholder="Yeni ≈üifreyi girin" minlength="6">
                            <small class="text-muted">Kullanƒ±cƒ± sisteme bu ≈üifre ile giri≈ü yapacak.</small>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary"
                                onclick="closeModal('passwordModal')">ƒ∞ptal</button>
                            <button type="submit" class="btn btn-primary">≈ûifreyi G√ºncelle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        </div>
        <script src="/js/utils.js?v=1.0"></script>
        <script src="/js/custom-dropdown.js"></script>
    </body>

</html>