<!DOCTYPE html>
<html lang="tr">
<!-- DEBUG: FORCE VISUAL CHANGE v2.7 -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>YÃ¶netim Paneli - Åirket PortalÄ±</title>
    <link rel="stylesheet" href="/css/style.css?v=2.5">
    <script>
        // FAILSAFE: Global Error Handler
        window.onerror = function (msg, url, line) {
            alert(`Sistem HatasÄ±:\n${msg}\nSatÄ±r: ${line}`);
            document.querySelectorAll('tbody').forEach(el => {
                el.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center; padding:20px;">
                    âš ï¸ KRÄ°TÄ°K HATA: ${msg}
                </td></tr>`;
            });
            return false;
        };

        // FAILSAFE: Loading Watchdog (10s)
        setTimeout(() => {
            if (document.body.innerHTML.includes('loader')) {
                console.warn('âš ï¸ Loading stuck detected by watchdog');
                document.querySelectorAll('.loader').forEach(loader => {
                    const parent = loader.parentElement;
                    if (parent) {
                        parent.innerHTML = '<div style="color:red">âš ï¸ YanÄ±t alÄ±namadÄ± (Watchdog). LÃ¼tfen sayfayÄ± yenileyin.</div>';
                    }
                });
            }
        }, 10000);

        // Utility: Timeout wrapper for fetch
        const fetchWithTimeout = async (resource, options = {}) => {
            const { timeout = 8000 } = options;
            let url = resource;
            if (url.includes('?')) {
                url += `&_t=${Date.now()}`;
            } else {
                url += `?_t=${Date.now()}`;
            }

            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    cache: 'no-store',
                    headers: {
                        ...options.headers,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        };

        async function checkAuth() {
            console.log('ğŸ”’ Checking Auth...');
            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) {
                    window.location.href = '/index.html';
                    return;
                }
                const user = await response.json();
                console.log('ğŸ‘¤ User:', user);

                if (user.role !== 'admin') {
                    window.location.href = '/dashboard.html';
                    return;
                }

                document.getElementById('userName').textContent = user.full_name;
                document.getElementById('userRole').textContent = 'ğŸ‘‘ YÃ¶netici';
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/index.html';
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/index.html';
        }

        async function loadUsers() {
            const container = document.getElementById('usersContainer');
            try {
                const response = await fetchWithTimeout('/api/admin/users');
                if (!response.ok) throw new Error('KullanÄ±cÄ±lar alÄ±namadÄ±');

                const users = await response.json();

                container.innerHTML = users.map(user => {
                    const linkedEmp = user.employee ? `<span class="badge badge-success">ğŸ‘¤ ${user.employee.full_name}</span>` : '<span class="text-muted">-</span>';
                    const empId = user.employee ? user.employee.id : '';

                    return `
                    <tr>
                    <td><strong>${user.full_name}</strong></td>
                    <td>${user.username}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'badge-error' : 'badge-secondary'}">${user.role === 'admin' ? 'YÃ¶netici' : 'Personel'}</span></td>
                    <td>${linkedEmp}</td>
                    <td>${new Date(user.created_at).toLocaleDateString('tr-TR')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openLinkModal(${user.id}, '${user.username}', '${empId}')">ğŸ”— EÅŸleÅŸtir</button>
                    </td>
                    </tr>
                `;
                }).join('');
            } catch (error) {
                console.error('KullanÄ±cÄ± yÃ¼kleme hatasÄ±:', error);
                container.innerHTML = `<tr><td colspan="6" class="text-center text-danger">âš ï¸ Hata: ${error.message}</td></tr>`;
            }
        }

        function addUser() {
            document.getElementById('userForm').reset();
            const modal = document.getElementById('userModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        async function submitUserForm(e) {
            e.preventDefault();

            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const full_name = document.getElementById('newFullName').value;
            const role = document.getElementById('newRole').value;

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, full_name, role })
                });

                if (response.ok) {
                    closeModal('userModal');
                    loadUsers();
                    alert('KullanÄ±cÄ± baÅŸarÄ±yla oluÅŸturuldu');
                } else {
                    const res = await response.json();
                    alert('Hata: ' + (res.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error(error);
                alert('BaÄŸlantÄ± hatasÄ±!');
            }
        }

        async function loadPaymentAccounts() {
            const container = document.getElementById('accountsContainer');
            if (container.innerHTML.includes('loader')) {
                container.innerHTML = '<tr><td colspan="4" class="text-center"><div class="loader"></div><br><small>Hesaplar aranÄ±yor...</small></td></tr>';
            }

            try {
                const response = await fetchWithTimeout('/api/payment-accounts');
                if (!response.ok) throw new Error(`Sunucu HatasÄ±: ${response.status}`);
                const accounts = await response.json();

                if (accounts.length === 0) {
                    container.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Hesap bulunamadÄ± (Yeni ekleyin)</td></tr>';
                    return;
                }

                container.innerHTML = accounts.map(acc => `
                    <tr>
                        <td><strong>${acc.name}</strong></td>
                        <td>${acc.type === 'bank' ? 'Banka' : acc.type === 'credit_card' ? 'Kredi KartÄ±' : 'Nakit'}</td>
                        <td>${acc.icon || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteAccount(${acc.id})">Sil</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Hesap yÃ¼kleme hatasÄ±:', error);
                const msg = error.name === 'AbortError' ? 'Zaman aÅŸÄ±mÄ± (Sunucu yanÄ±t vermedi)' : error.message;
                container.innerHTML =
                    `<tr><td colspan="4" class="text-center text-danger">âš ï¸ Hata: ${msg} <br> <button class="btn btn-sm btn-outline-secondary mt-2" onclick="loadPaymentAccounts()">Tekrar Dene</button></td></tr>`;
            }
        }

        // --- Link Employee Functions ---
        let allEmployees = [];

        async function loadEmployeesForSelect() {
            try {
                const response = await fetch('/api/employees');
                if (!response.ok) return;
                allEmployees = await response.json();

                // Populate Select
                const select = document.getElementById('linkEmployeeSelect');
                select.innerHTML = '<option value="">-- BaÄŸlantÄ±yÄ± KaldÄ±r --</option>' +
                    allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name} (${emp.role === 'manager' ? 'YÃ¶netici' : 'Personel'})</option>`).join('');

            } catch (error) {
                console.error('Personel yÃ¼kleme hatasÄ±:', error);
            }
        }

        async function openLinkModal(userId, username, currentEmpId) {
            document.getElementById('linkUserId').value = userId;
            document.getElementById('linkUserName').value = username;

            await loadEmployeesForSelect();

            const select = document.getElementById('linkEmployeeSelect');
            if (currentEmpId) {
                select.value = currentEmpId;
            } else {
                select.value = "";
            }

            document.getElementById('linkEmployeeModal').style.display = 'flex';
        }

        async function saveLink() {
            const userId = document.getElementById('linkUserId').value;
            const empId = document.getElementById('linkEmployeeSelect').value;

            try {
                const response = await fetch(`/api/admin/users/${userId}/link-employee`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_id: empId || null })
                });

                const result = await response.json();

                if (response.ok) {
                    closeModal('linkEmployeeModal');
                    loadUsers();
                    alert('BaÄŸlantÄ± gÃ¼ncellendi');
                } else {
                    alert('Hata: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z');
            }
        }

        // Modal Utilities
        function openAccountModal() {
            document.getElementById('accountForm').reset();
            document.getElementById('accIcon').value = 'ğŸ¦';
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            document.querySelector('.emoji-option').classList.add('selected');
            document.getElementById('accountModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function selectEmoji(element, emoji) {
            document.getElementById('accIcon').value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Admin Page v2.7 Loaded');

            checkAuth();
            loadPaymentAccounts();
            loadUsers();

            // Account Form
            const accountForm = document.getElementById('accountForm');
            if (accountForm) {
                accountForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('accName').value;
                    const type = document.getElementById('accType').value;
                    const icon = document.getElementById('accIcon').value;

                    try {
                        const response = await fetch('/api/payment-accounts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, type, icon })
                        });

                        if (response.ok) {
                            closeModal('accountModal');
                            loadPaymentAccounts();
                            alert('Hesap eklendi');
                        } else {
                            alert('Hata oluÅŸtu!');
                        }
                    } catch (error) {
                        console.error('Form submit error:', error);
                        alert('Bir hata oluÅŸtu: ' + error.message);
                    }
                });
            }

            // User Form
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', submitUserForm);
            }

            // Link Employee Form
            const linkForm = document.getElementById('linkEmployeeForm');
            if (linkForm) {
                linkForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveLink();
                });
            }
        });
    </script>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><span class="logo-icon">ğŸ¢</span>Åirket PortalÄ±</div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/dashboard.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span>Ana
                        Sayfa</a></li>
                <li class="nav-item"><a href="/jobs.html" class="nav-link"><span class="nav-icon">ğŸ“‹</span>Ä°ÅŸ
                        Listeleri</a></li>
                <li class="nav-item"><a href="/sources.html" class="nav-link"><span
                            class="nav-icon">ğŸ“¦</span>Kaynaklar</a></li>
                <li class="nav-item">
                    <a href="/products.html" class="nav-link">
                        <span class="nav-icon">ğŸ”§</span>
                        ÃœrÃ¼nler
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/attendance.html" class="nav-link">
                        <span class="nav-icon">ğŸ“…</span>
                        Ã‡alÄ±ÅŸma KaydÄ±
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/salary.html" class="nav-link">
                        <span class="nav-icon">ğŸ’°</span>
                        MaaÅŸ YÃ¶netimi
                    </a>
                </li>

                <li class="nav-item" id="adminLink"><a href="/admin.html" class="nav-link active"><span
                            class="nav-icon">âš™ï¸</span>YÃ¶netim</a></li>
            </ul>
            <div class="user-info">
                <div class="user-name" id="userName">...</div>
                <div class="user-role" id="userRole"></div>
                <button class="btn btn-secondary btn-sm btn-block" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </aside>
        <main class="main-content">
            <h1 class="page-title mb-4">YÃ¶netim Paneli</h1>



            <div class="card mb-4">
                <div class="card-header">
                    <span>ğŸ’³ Ã–deme HesaplarÄ± (Kasa/Banka)</span>
                    <button class="btn btn-success btn-sm" onclick="openAccountModal()">+ Yeni Hesap</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Hesap AdÄ±</th>
                                <th>Tip</th>
                                <th>Ä°kon</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="accountsContainer">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="loader"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>ğŸ‘¥ KullanÄ±cÄ±lar</span>
                    <button class="btn btn-primary btn-sm" onclick="addUser()">+ Yeni KullanÄ±cÄ±</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ad Soyad</th>
                                <th>KullanÄ±cÄ± AdÄ±</th>
                                <th>Rol</th>
                                <th>BaÄŸlÄ± Personel</th>
                                <th>KayÄ±t Tarihi</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="usersContainer">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="loader"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Account Add Modal -->
        <div id="accountModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Yeni Ã–deme HesabÄ± Ekle</h2>
                    <button class="modal-close" onclick="closeModal('accountModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="accountForm">
                        <div class="form-group">
                            <label>Hesap AdÄ±</label>
                            <input type="text" id="accName" placeholder="Ã–rn: Ziraat BankasÄ±" required>
                        </div>

                        <div class="form-group">
                            <label>Hesap Tipi</label>
                            <select id="accType" class="form-control">
                                <option value="bank">Banka</option>
                                <option value="cash">Nakit Kasa</option>
                                <option value="credit_card">Kredi KartÄ±</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ä°kon SeÃ§imi</label>
                            <input type="hidden" id="accIcon" value="ğŸ¦">
                            <div class="emoji-grid">
                                <div class="emoji-option selected" onclick="selectEmoji(this, 'ğŸ¦')">ğŸ¦</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ’³')">ğŸ’³</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ’µ')">ğŸ’µ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ’°')">ğŸ’°</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ§')">ğŸ§</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸª™')">ğŸª™</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ§¾')">ğŸ§¾</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ“‰')">ğŸ“‰</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ“Š')">ğŸ“Š</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ’¼')">ğŸ’¼</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ‘œ')">ğŸ‘œ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'ğŸ”')">ğŸ”</div>
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary"
                                onclick="closeModal('accountModal')">Ä°ptal</button>
                            <button type="submit" class="btn btn-primary">HesabÄ± OluÅŸtur</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="userModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Yeni KullanÄ±cÄ± Ekle</h2>
                    <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="form-group">
                            <label>KullanÄ±cÄ± AdÄ±</label>
                            <input type="text" id="newUsername" required placeholder="GiriÅŸ iÃ§in kullanÄ±lacak">
                        </div>

                        <div class="form-group">
                            <label>Åifre</label>
                            <input type="password" id="newPassword" required placeholder="En az 6 karakter">
                        </div>

                        <div class="form-group">
                            <label>Ad Soyad</label>
                            <input type="text" id="newFullName" required placeholder="GÃ¶rÃ¼necek isim">
                        </div>

                        <div class="form-group">
                            <label>Rol</label>
                            <select id="newRole">
                                <option value="staff">Personel</option>
                                <option value="admin">YÃ¶netici</option>
                            </select>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary"
                                onclick="closeModal('userModal')">Ä°ptal</button>
                            <button type="submit" class="btn btn-primary">KullanÄ±cÄ±yÄ± OluÅŸtur</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Link Employee Modal -->
        <div id="linkEmployeeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>KullanÄ±cÄ± - Personel EÅŸleÅŸmesi</h2>
                    <button class="modal-close" onclick="closeModal('linkEmployeeModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="mb-3 text-muted">Bu kullanÄ±cÄ±yÄ± bir personel ile eÅŸleÅŸtirin. BÃ¶ylece personel sadece kendi
                        verilerini gÃ¶rÃ¼r.</p>
                    <form id="linkEmployeeForm">
                        <input type="hidden" id="linkUserId">
                        <div class="form-group">
                            <label>KullanÄ±cÄ±</label>
                            <input type="text" id="linkUserName" class="form-control" disabled
                                style="background: #f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label>BaÄŸlanacak Personel</label>
                            <select id="linkEmployeeSelect" class="form-control">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <small class="text-warning" id="linkWarning" style="display: none;">âš ï¸ Bu personel zaten
                                baÅŸka bir kullanÄ±cÄ±ya baÄŸlÄ±. DeÄŸiÅŸtirirseniz eski baÄŸlantÄ± kopar.</small>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary"
                                onclick="closeModal('linkEmployeeModal')">VazgeÃ§</button>
                            <button type="submit" class="btn btn-primary">Kaydet ve EÅŸleÅŸtir</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>

</html>