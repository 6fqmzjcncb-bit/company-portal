<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personel Listesi - Åirket PortalÄ±</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">ğŸ¢</div>
                <h1 class="sidebar-title">Åirket PortalÄ±</h1>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/dashboard.html" class="nav-link">
                        <span class="nav-icon">ğŸ“Š</span>
                        Ana Sayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/jobs.html" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        Ä°ÅŸ Listeleri
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/sources.html" class="nav-link">
                        <span class="nav-icon">ğŸ“¦</span>
                        Kaynaklar
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/products.html" class="nav-link">
                        <span class="nav-icon">ğŸ”§</span>
                        ÃœrÃ¼nler
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/attendance.html" class="nav-link">
                        <span class="nav-icon">ğŸ“…</span>
                        Ã‡alÄ±ÅŸma KaydÄ±
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/salary.html" class="nav-link">
                        <span class="nav-icon">ğŸ’°</span>
                        MaaÅŸ YÃ¶netimi
                    </a>
                </li>
                <li class="nav-item" id="adminLink" style="display: none;">
                    <a href="/admin.html" class="nav-link">
                        <span class="nav-icon">âš™ï¸</span>
                        YÃ¶netim
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">YÃ¼klen iyor...</div>
                        <div class="user-role" id="userRole"></div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ğŸ‘¥ Personel YÃ¶netimi</h1>
                <button class="btn btn-primary" onclick="showAddModal()">+ Yeni Personel</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Personel Listesi</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Personel ara..." onkeyup="filterEmployees()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>KullanÄ±cÄ± AdÄ±</th>
                                    <th>Åifre</th>
                                    <th>Telefon</th>
                                    <th>Rol</th>
                                    <th>GÃ¼nlÃ¼k Ãœcret</th>
                                    <th>AylÄ±k MaaÅŸ</th>
                                    <th>Ä°ÅŸe BaÅŸlama</th>
                                    <th>Durum</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="employeeList">
                                <tr>
                                    <td colspan="10" class="text-center">YÃ¼kleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Yeni Personel Ekle</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <input type="hidden" id="employeeId">

                    <div class="form-group">
                        <label for="fullName">Ad Soyad *</label>
                        <input type="text" id="fullName" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Telefon</label>
                        <input type="text" id="phone" placeholder="05xx xxx xx xx">
                    </div>

                    <div class="form-group">
                        <label for="role">Rol *</label>
                        <select id="role" required>
                            <option value="worker">Ä°ÅŸÃ§i</option>
                            <option value="supervisor">UstabaÅŸÄ±</option>
                            <option value="manager">YÃ¶netici</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dailyWage">GÃ¼nlÃ¼k Ãœcret (â‚º)</label>
                        <input type="number" id="dailyWage" step="0.01" min="0">
                    </div>

                    <div class="form-group">
                        <label for="monthlySalary">AylÄ±k MaaÅŸ (â‚º)</label>
                        <input type="number" id="monthlySalary" step="0.01" min="0">
                    </div>

                    <div class="form-group">
                        <label for="hireDate">Ä°ÅŸe BaÅŸlama Tarihi</label>
                        <input type="date" id="hireDate">
                    </div>

                    <div class="form-group">
                        <label for="notes">Notlar</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Ä°ptal</button>
                        <button type="button" class="btn btn-primary" onclick="forceSaveEmployee()">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/employees.js?v=5"></script>
    <script>
        // Emergency Inline Script to bypass cache issues
        async function forceSaveEmployee() {
            console.log('Force Save called');
            const submitBtn = document.querySelector('#employeeForm button.btn-primary');
            const originalText = submitBtn ? submitBtn.innerText : 'Kaydet';

            // Validation
            const fullNameInput = document.getElementById('fullName');
            const roleInput = document.getElementById('role');

            if (!fullNameInput || !roleInput) {
                alert('Hata: Form elemanlarÄ± bulunamadÄ±!');
                return;
            }

            if (!fullNameInput.value || !roleInput.value) {
                alert('LÃ¼tfen Ad Soyad ve Rol alanlarÄ±nÄ± doldurun.');
                return;
            }

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerText = 'Ä°ÅŸleniyor...';
            }

            const formData = {
                full_name: fullNameInput.value,
                phone: document.getElementById('phone').value || null,
                role: roleInput.value,
                daily_wage: document.getElementById('dailyWage').value || null,
                monthly_salary: document.getElementById('monthlySalary').value || null,
                hire_date: document.getElementById('hireDate').value || null,
                notes: document.getElementById('notes').value || null,
                is_active: true
            };

            // Get editingId from global scope or hidden input if available
            // Assuming editingId is a global variable from employees.js. 
            // If employees.js didn't load, this might fail. 
            // Let's rely on the hidden input if possible, or check window.editingId
            const hiddenId = document.getElementById('employeeId').value;
            const isEditing = hiddenId && hiddenId !== '';

            const url = isEditing ? `/api/employees/${hiddenId}` : '/api/employees';
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    throw new Error('Sunucudan geÃ§ersiz yanÄ±t');
                }

                if (!response.ok) throw new Error(result.error || 'KayÄ±t baÅŸarÄ±sÄ±z');

                if (result.createdUser) {
                    alert(`âœ… Personel ve KullanÄ±cÄ± HesabÄ± OluÅŸturuldu!\n\nğŸ‘¤ KullanÄ±cÄ± AdÄ±: ${result.createdUser.username}\nğŸ”‘ Åifre: ${result.createdUser.password}\n\nLÃ¼tfen bu bilgileri personel ile paylaÅŸÄ±n.`);
                } else {
                    alert(isEditing ? 'Personel gÃ¼ncellendi' : 'Personel eklendi');
                }

                // Try to close modal and reload
                if (window.closeModal) window.closeModal();
                else document.getElementById('employeeModal').style.display = 'none';

                if (window.loadEmployees) window.loadEmployees();
                else location.reload();

            } catch (error) {
                console.error(error);
                alert('Hata: ' + error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalText;
                }
            }
        }
    </script>
</body>

</html>