<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°ÅŸ Listeleri - Åirket PortalÄ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <script>
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) window.location.href = '/index.html';
                const user = await response.json();
                document.getElementById('userName').textContent = user.full_name;
                document.getElementById('userRole').textContent = user.role === 'admin' ? 'ğŸ‘‘ YÃ¶netici' : 'ğŸ‘¤ Personel';
                if (user.role === 'admin') document.getElementById('adminLink').style.display = 'block';
            } catch (error) { window.location.href = '/index.html'; }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/index.html';
        }

        async function loadJobs() {
            const response = await fetch('/api/jobs');
            const jobs = await response.json();
            const container = document.getElementById('jobsContainer');

            if (jobs.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">HenÃ¼z iÅŸ listesi yok</p>';
                return;
            }

            const statusColors = { pending: 'warning', processing: 'primary', completed: 'success' };
            const statusLabels = { pending: 'Bekliyor', processing: 'Ä°ÅŸlemde', completed: 'TamamlandÄ±' };

            container.innerHTML = jobs.map(job => {
                const viewersText = job.recent_viewers && job.recent_viewers.length > 0
                    ? job.recent_viewers.map(v => v.full_name).join(', ')
                    : 'HenÃ¼z kimse bakmadÄ±';

                return `
        <div class="card">
          <div class="card-header">
            <div>
              <strong>${job.title}</strong>
              <div class="text-sm text-muted">${job.creator.full_name} - ${new Date(job.created_at).toLocaleDateString('tr-TR')}</div>
            </div>
            <span class="badge badge-${statusColors[job.status]}">${statusLabels[job.status]}</span>
          </div>
          <div class="card-body" style="padding: 12px 20px;">
            <div style="margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px;">
                <span><strong>Tamamlanma:</strong></span>
                <span><strong>%${job.completion_percentage || 0}</strong></span>
              </div>
              <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                <div style="background: #059669; height: 100%; width: ${job.completion_percentage || 0}%; transition: width 0.3s;"></div>
              </div>
            </div>
            <div style="font-size: 0.8rem; color: #6b7280;">
              <span>ğŸ‘ï¸ ${viewersText}</span>
            </div>
          </div>
          <div class="card-footer">
            <a href="/job-detail.html?id=${job.id}" class="btn btn-primary btn-sm">Detay GÃ¶r</a>
          </div>
        </div>
      `;
            }).join('');
        }

        async function createNewJob() {
            const title = prompt('Ä°ÅŸ listesi baÅŸlÄ±ÄŸÄ±:');
            if (!title) return;

            const response = await fetch('/api/jobs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title })
            });

            if (response.ok) {
                const job = await response.json();
                window.location.href = `/job-detail.html?id=${job.id}`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadJobs();
        });
    </script>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><span class="logo-icon">ğŸ¢</span>Åirket PortalÄ±</div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/dashboard.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span>Ana
                        Sayfa</a></li>
                <li class="nav-item"><a href="/jobs.html" class="nav-link active"><span class="nav-icon">ğŸ“‹</span>Ä°ÅŸ
                        Listeleri</a></li>
                <li class="nav-item"><a href="/sources.html" class="nav-link"><span
                            class="nav-icon">ğŸ“¦</span>Kaynaklar</a></li>
                <li class="nav-item">
                    <a href="/products.html" class="nav-link">
                        <span class="nav-icon">ğŸ”§</span>
                        ÃœrÃ¼nler
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/employees.html" class="nav-link">
                        <span class="nav-icon">ğŸ‘¥</span>
                        Personel
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/attendance.html" class="nav-link">
                        <span class="nav-icon">ğŸ“…</span>
                        Ã‡alÄ±ÅŸma KaydÄ±
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/salary.html" class="nav-link">
                        <span class="nav-icon">ğŸ’°</span>
                        MaaÅŸ YÃ¶netimi
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/stock-movements.html" class="nav-link">
                        <span class="nav-icon">ğŸ“Š</span>
                        Stok Hareketi
                    </a>
                </li>
                <li class="nav-item" id="adminLink" style="display:none;"><a href="/admin.html" class="nav-link"><span
                            class="nav-icon">âš™ï¸</span>YÃ¶netim</a></li>
            </ul>
            <div class="user-info">
                <div class="user-name" id="userName">...</div>
                <div class="user-role" id="userRole"></div>
                <button class="btn btn-secondary btn-sm btn-block" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </aside>
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Ä°ÅŸ Listeleri</h1>
                <button class="btn btn-primary" onclick="createNewJob()">+ Yeni Liste OluÅŸtur</button>
            </div>
            <div id="jobsContainer">
                <div class="loader"></div>
            </div>
        </main>
    </div>
</body>

</html>