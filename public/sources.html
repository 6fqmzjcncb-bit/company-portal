<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaynaklar - Åirket PortalÄ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/custom-dropdown.css">
    <script>
        let currentUser = null;

        async function checkAuth() {
            const cachedUser = localStorage.getItem('user_cache');
            if (cachedUser) {
                try {
                    const user = JSON.parse(cachedUser);
                    updateUserInterface(user);
                } catch (e) {
                    console.error(e);
                }
            }

            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) {
                    localStorage.removeItem('user_cache');
                    window.location.href = '/index.html';
                    return null;
                }
                const user = await response.json();
                localStorage.setItem('user_cache', JSON.stringify(user));
                updateUserInterface(user);
                return user;
            } catch (error) {
                if (!cachedUser) window.location.href = '/index.html';
            }
        }

        function updateUserInterface(user) {
            document.getElementById('userName').textContent = user.full_name;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'ğŸ‘‘ YÃ¶netici' : 'ğŸ‘¤ Personel';
            if (user.role === 'admin') {
                const adminLink = document.getElementById('adminLink');
                if (adminLink) adminLink.style.display = 'block';
                const addBtn = document.getElementById('addBtn');
                if (addBtn) addBtn.style.display = 'block';
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/index.html';
        }

        async function loadSources() {
            const response = await fetch('/api/sources');
            const sources = await response.json();
            const container = document.getElementById('sourcesContainer');

            if (sources.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">HenÃ¼z kaynak yok</p>';
                return;
            }

            container.innerHTML = sources.map(source => `
        <div class="card" style="border-left: 4px solid ${source.color_code};">
          <div class="card-body">
            <div class="flex justify-between items-center">
              <div>
                <strong>${source.name}</strong>
                <div class="text-sm text-muted">${source.type === 'internal' ? 'Ä°Ã§ Depo' : 'DÄ±ÅŸ TedarikÃ§i'}</div>
              </div>
              <div style="width: 40px; height: 40px; background-color: ${source.color_code}; border-radius: 8px;"></div>
            </div>
          </div>
        </div>
      `).join('');
        }

        function addSource() {
            document.getElementById('addSourceForm').reset();
            // Sync color picker default
            document.getElementById('sourceColorPicker').value = '#d4edda';
            document.getElementById('sourceColor').value = '#d4edda';

            const modal = document.getElementById('addSourceModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeSourceModal() {
            const modal = document.getElementById('addSourceModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadSources();

            // Color picker sync
            const picker = document.getElementById('sourceColorPicker');
            const text = document.getElementById('sourceColor');
            picker.addEventListener('input', (e) => text.value = e.target.value);
            text.addEventListener('input', (e) => picker.value = e.target.value);

            // Form Submit
            document.getElementById('addSourceForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('sourceName').value;
                const color_code = document.getElementById('sourceColor').value;
                const type = document.getElementById('sourceType').value;

                try {
                    const response = await fetch('/api/sources', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color_code, type })
                    });

                    if (response.ok) {
                        closeSourceModal();
                        loadSources();
                    } else {
                        showAlert('Hata oluÅŸtu');
                    }
                } catch (error) {
                    console.error(error);
                    showAlert('BaÄŸlantÄ± hatasÄ±');
                }
            });
        });
    </script>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><span class="logo-icon">ğŸ¢</span>Åirket PortalÄ±</div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/dashboard.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span>Ana
                        Sayfa</a></li>
                <li class="nav-item"><a href="/jobs.html" class="nav-link"><span class="nav-icon">ğŸ“‹</span>Ä°ÅŸ
                        Listeleri</a></li>
                <li class="nav-item"><a href="/sources.html" class="nav-link active"><span
                            class="nav-icon">ğŸ“¦</span>Kaynaklar</a></li>
                <li class="nav-item">
                    <a href="/products.html" class="nav-link">
                        <span class="nav-icon">ğŸ”§</span>
                        ÃœrÃ¼nler
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/attendance.html" class="nav-link">
                        <span class="nav-icon">ğŸ“…</span>
                        Ã‡alÄ±ÅŸma KaydÄ±
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/salary.html" class="nav-link">
                        <span class="nav-icon">ğŸ’°</span>
                        MaaÅŸ YÃ¶netimi
                    </a>
                </li>

                <li class="nav-item" id="adminLink" style="display:none;"><a href="/admin.html" class="nav-link"><span
                            class="nav-icon">âš™ï¸</span>YÃ¶netim</a></li>
            </ul>
            <div class="user-info">
                <div class="user-name" id="userName">...</div>
                <div class="user-role" id="userRole"></div>
                <button class="btn btn-secondary btn-sm btn-block" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </aside>
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Kaynaklar</h1>
                <button id="addBtn" class="btn btn-primary" onclick="addSource()" style="display:none;">+ Yeni
                    Kaynak</button>
            </div>
            <div class="grid grid-3" id="sourcesContainer">
                <div class="loader"></div>
            </div>
        </main>
    </div>

    <script src="/js/utils.js?v=1.0"></script>
    <script src="/js/custom-dropdown.js"></script>
    <!-- NEW SOURCE MODAL -->
    <div id="addSourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“¦ Yeni Kaynak Ekle</h2>
                <button class="modal-close" onclick="closeSourceModal()">Ã—</button>
            </div>
            <form id="addSourceForm">
                <div class="form-group">
                    <label class="form-label">Kaynak AdÄ±</label>
                    <input type="text" id="sourceName" class="form-input" required placeholder="Ã–rn: Merkez Depo">
                </div>
                <div class="form-group">
                    <label class="form-label">Renk Kodu</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="sourceColorPicker" value="#d4edda"
                            style="width: 50px; height: 40px; padding: 0; border: none; background: none;">
                        <input type="text" id="sourceColor" class="form-input" value="#d4edda" required
                            placeholder="#d4edda">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">TÃ¼r</label>
                    <select id="sourceType" class="form-select" data-custom-dropdown data-searchable="false"
                        data-placeholder="TÃ¼r SeÃ§iniz">
                        <option value="external">DÄ±ÅŸ TedarikÃ§i</option>
                        <option value="internal">Ä°Ã§ Depo</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSourceModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</body>

</html>